<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>교사의 교육과정 해석을 통한 의미 구성의 코드 유형 탐구(Q방법론)</title>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>교사의 교육과정 해석을 통한 의미 구성의 코드 유형 탐구(Q방법론)</title>

<style>
/* 🔽 기존 index-fixed-final.html의 CSS 전부 그대로 넣어주세요 */
</style>

<!-- ✅ 토큰 인증 스크립트 -->
<script>
const TOKEN_API_URL = "https://script.google.com/macros/s/AKfycbzhxw3kVbBBEJhPGAHXBxoL4S7vZKbqwCK5I5PeaeYEDLIO0u1l2VYwTpAMi-ywRem6og/exec";

// JSONP 호출
function jsonp(url, params) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).substring(2);
    params.callback = cb;
    const qs = Object.keys(params).map(k => `${k}=${encodeURIComponent(params[k])}`).join("&");
    const script = document.createElement("script");
    script.src = url + "?" + qs;
    window[cb] = function(data) {
      resolve(data);
      document.body.removeChild(script);
      delete window[cb];
    };
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

function getTokenFromURL(){
  const u = new URL(location.href);
  let t = u.searchParams.get('token') || u.searchParams.get('t');
  if (!t && location.hash){
    const m = location.hash.match(/token=([^&]+)/);
    if (m) t = m[1];
  }
  return t || '';
}

async function serverValidateToken(token) {
  return await jsonp(TOKEN_API_URL, { action: 'checkToken', token });
}
async function markTokenUsed(token) {
  return await jsonp(TOKEN_API_URL, { action: 'markUsed', token });
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const token = getTokenFromURL();
  if (!token) {
    document.body.innerHTML = "<h2 style='color:red'>⚠ 토큰이 없습니다. 개인 전용 링크로 접속해 주세요.</h2>";
    return;
  }
  const statusBox = document.createElement("div");
  statusBox.id = "status";
  statusBox.style.color = "red";
  statusBox.style.margin = "16px";
  statusBox.innerText = "토큰 확인 중...";
  document.body.prepend(statusBox);

  try {
    const res = await serverValidateToken(token);
    if (!res.ok && res.status==="invalid") {
      statusBox.innerText = "잘못된 토큰입니다.";
      return;
    }
    if (res.status==="used") {
      statusBox.innerText = "이미 사용된 토큰입니다.";
      return;
    }
    if (res.status==="valid") {
      statusBox.remove();
      if (typeof initSurvey === "function") initSurvey();  // ✅ 설문 시작
    }
  } catch(err) {
    statusBox.innerText = "토큰 검증 오류: " + err;
  }
});

async function finalizeSurvey(){
  const token = getTokenFromURL();
  await markTokenUsed(token);
}
</script>
</head>
<body>

<header>
  <div class="wrap">
    <h1>교사의 교육과정 해석을 통한 의미 구성의 코드 유형 탐구(Q방법론)</h1>
    <div class="sub">
      1단계에서 응답자 정보를 입력하고, 2단계에서 Q진술문 카드를 분포에 맞게 배치한 뒤 제출해 주세요.<br/>
      제공해주신 개인정보 및 응답 결과는 연구에만 사용되며, 연구 종료 즉시 폐기됩니다.
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Page 1: 응답자 정보 -->
  <section class="page" id="page1">
    <!-- 🔽 선생님 원본 응답자 정보 입력 폼 전체 -->
  </section>

  <!-- Page 2: Q-sort -->
  <section class="page hidden" id="page2">
    <!-- 🔽 39개 진술문 Q-sort 보드 + 카드풀 전체 -->
    <button id="submitBtn">제출</button>
  </section>

  <!-- Page 3: 제출 완료 -->
  <section class="page hidden" id="page3">
    <h2>제출 완료</h2>
    <p>설문에 참여해 주셔서 감사합니다. 결과가 성공적으로 제출되었습니다.</p>
  </section>
</main>

<script>
// ✅ 설문 초기화
function initSurvey(){
  renderColumns();
  ensureCards();
  setUniformCardSize();
  showPage(1);

  document.getElementById('nextBtn').addEventListener('click', ()=> showPage(2));
  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    const ok = await submitToSheet(); // 원래 있던 Google Sheets 제출 로직
    if(ok){
      await finalizeSurvey();
      showPage(3);
    }
  });
}
</script>

<!-- 🔽 선생님 원본 index-fixed-final.html 안의 JS 전체 (STATEMENTS 배열, Q-sort 드래그/드롭, submitToSheet 등) -->
<script>
/* 여기에 원본 JS 코드 전부 붙여넣으시면 됩니다 */
</script>

</body>
</html>

    <style>
    :root{ --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#6366f1; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.6));backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px}
    .hidden{display:none}
    button,select,input,textarea{background:var(--card);color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px 12px;font-size:14px}
    button{font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    button:hover{border-color:var(--accent)}
    input,textarea,select{width:100%}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:12px}
    #pool,.col{background:var(--panel);border:1px solid #2b3647;border-radius:12px}
    #pool{padding:12px;min-height:220px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .note{font-size:13px;color:var(--muted)}
    .cols{display:grid;gap:10px}
    .row{display:grid;gap:10px;grid-template-columns:repeat(9,1fr)}
    .col{min-height: 80px;padding:8px;display:flex;flex-direction:column}
    .col-header{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;margin-bottom:6px;border-bottom:1px dashed #334155}
    .tag{font-size:12px;color:var(--muted)}
    .cap{font-size:12px}
    .bucket{display:flex;flex-direction:column;gap:6px}
    .card{font-size: 13px; background:var(--card);border:1px solid #334155;border-radius:12px;padding: 8px 10px;cursor:grab;margin-bottom:6px}
    .card.dragging{opacity:.6}
    .col.over{outline:2px dashed var(--accent);outline-offset:-4px}
    .count-ok{color:var(--ok)}
    .count-warn{color:var(--warn)}
    .count-bad{color:var(--bad)}
    .small{font-size:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#0b1222;border:1px solid #2b3647;border-radius:999px;padding:2px 8px;font-size:12px}
    .page{max-width:900px;margin:20px auto;padding:16px;background:var(--panel);border:1px solid #2b3647;border-radius:14px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}

    /* Gate (token access) */
    #gate { max-width:900px;margin:20px auto;padding:16px;background:var(--panel);border:1px solid #2b3647;border-radius:14px }
    #gate .status { font-size:14px; color: var(--muted); margin-top:8px }

    /* Modal styles */
    .modal.hidden { display: none; }
    .modal { position: fixed; inset: 0; z-index: 1000; }
    .modal__overlay { position:absolute; inset:0; background: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    .modal__content { position:relative; max-width: 720px; margin: 8vh auto; background: var(--panel); border:1px solid #2b3647; border-radius: 12px; padding: 16px; }
</style>
<style>
/* === Responsive width tuning (columns >= card width) === */
:root { --card-w: 240px; }

@media (max-width: 1600px) { :root { --card-w: 220px; } }
@media (max-width: 1440px) { :root { --card-w: 200px; } }
@media (max-width: 1280px) { :root { --card-w: 180px; } }

/* Use almost full viewport width */
.page { max-width: 98vw !important; }

/* Shrink left sidebar when space tight, give all remaining space to board */
.grid { grid-template-columns: clamp(200px, 18vw, 280px) 1fr !important; }

/* Each column at least as wide as a card */
.row { grid-template-columns: repeat(9, minmax(var(--card-w), 1fr)) !important; }

/* Cards fill column width; in the pool they use card width */
#pool .card { width: var(--card-w); }
.col .bucket .card { width: 100%; }

/* Slightly smaller gutters to win horizontal space */
.row { gap: 8px !important; }
.cols { gap: 8px !important; }

/* Modal styles */
.modal.hidden { display: none; }
.modal { position: fixed; inset: 0; z-index: 1000; }
.modal__overlay { position:absolute; inset:0; background: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
.modal__content { position:relative; max-width: 720px; margin: 8vh auto; background: var(--panel); border:1px solid #2b3647; border-radius: 12px; padding: 16px; }

</style>
<style>
/* 강조된 배치요령 버튼 */
.help-btn {
  background: #6366f1;
  color: #fff;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}
.help-btn:hover {
  background: #4f46e5;
  transform: scale(1.03);
}
</style>
<style>
/* Board wrapper for Q-sort columns */
.board {
  border: 1px solid #2b3647;
  border-radius: 12px;
  padding: 12px;
  background: var(--panel);
}
</style>
<style>
/* Re-introduce a clear dashed divider between pool and board, without crossing borders */
.grid { position: relative; align-items: start; } /* ensure titles align at top */
.grid::after {
  content: "";
  position: absolute;
  top: 0; bottom: 0;
  left: clamp(200px, 18vw, 280px);
  border-left: 2px dashed #334155;
  pointer-events: none;
  z-index: 1;
}
/* Make the board visually self-contained */
.board { position: relative; overflow: hidden; background: var(--panel); border: 1px solid #2b3647; border-radius: 12px; padding: 12px; }
</style>
<style>
/* Uniform card height based on longest statement */
:root { --card-h: auto; }
.card { height: var(--card-h); overflow:auto; }
</style>
<style>.col-header .tag { color: #ffffff; font-weight: bold; font-size: 15px; }</style>
<style>
/* Ensure vertical scroll in the card pool (poolList) */
#page2 aside #pool #poolList {
  display: block !important;
  max-height: 50vh !important;
  min-height: 240px;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding: 8px;               /* keep padding for readability */
  box-sizing: border-box;
  scrollbar-gutter: stable;
}
/* Keep pool cards full width of the list */
#page2 aside #pool #poolList .card {
  width: 100% !important;
}

#submitBtn {
  font-size: 18px;
  font-weight: bold;
  padding: 14px 22px;
  background: var(--accent);
  color: white;
  border-radius: 12px;
  border: none;
}
#submitBtn:hover {
  background: #4338ca;
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>교사의 교육과정 해석을 통한 의미 구성의 코드 유형 탐구(Q방법론)</h1>
    <div class="sub">
      1단계에서 응답자 정보를 입력하고, 2단계에서 Q진술문 카드를 분포에 맞게 배치한 뒤 제출부탁드립니다.<br/>
      제공해주신 개인 정보 및 응답 결과는 연구에만 사용되며, 연구 종료 즉시 폐기됩니다.
    </div>
  </div>
</header>

<!-- Token gate (보안: 토큰 소지자만 접근) -->
<section id="gate" class="wrap">
  <h2 style="margin:0 0 8px">접근 제한됨</h2>
  <p>해당 설문은 개별화된 접속 토큰을 포함한 링크로만 참여할 수 있습니다.<br/>올바른 링크인지 확인해 주세요.</p>
  <div class="status" id="gateStatus">토큰 확인 중…</div>
</section>

<main class="wrap hidden" id="appRoot">
  <!-- PAGE 1 -->
  <section class="page" id="page1">
    <h2 style="margin:0 0 12px">1단계: 응답자 정보를 입력하여 주세요.</h2>
    <!-- 1) 교직 경력 -->
    <div>
      <label for="career">선생님의 교직 경력을 선택하여 주세요. *</label>
      <select id="career" required>
        <option value="">선택하세요</option>
        <option value="under5">5년 미만</option>
        <option value="5to10">5년 이상 ~ 10년 미만</option>
        <option value="10to15">10년 이상 ~ 15년 미만</option>
        <option value="15to20">15년 이상 ~ 20년 미만</option>
        <option value="20to25">20년 이상 ~ 25년 미만</option>
        <option value="25plus">25년 이상</option>
      </select>
    </div>

    <div>
      <label for="schoolLevel">선생님께서 현재 근무하고 계신 학교급을 선택하여 주세요. *</label>
      <select id="schoolLevel" required>
        <option value="">선택하세요</option>
        <option value="middle">중학교</option>
        <option value="high">고등학교</option>
      </select>
    </div>

    <!-- 2) 참여 경험 체크박스 -->
    <div style="margin:14px 0">
      <label>선생님께서는 아래와 같은 작업에 참여하신 적이 있나요? (복수 선택 가능, 전혀 없음 선택 시 다른 항목 선택 불가) *</label>
      <div class="checkbox-group" id="experience-options">
        <label class="checkbox-item"><input name="experience" type="checkbox" value="curriculumDev"/> 국가수준 지리과 교육과정 개발 연구</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="textbookAuth"/> 지리과 검·인정 교과서 집필(검토 포함)</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="textbookReview"/> 지리과 교과서 검·인정 업무</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="materialDev"/> 지리과 개정 교육과정 관련 교수·학습 및 평가 자료 개발</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="trainingInstructor"/> 지리과 개정 교육과정 선도 교원 연수 강사</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="curriculumLeader"/> 지리과 개정 교육과정 선도 교원</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="plc"/> 지리 관련 전문적 교원 학습 공동체 활동(학교 안, 학교 밖 모두 포함)</label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="other"/> 기타: <input id="otherExp" placeholder="직접 입력" style="margin-left:6px;flex:1" type="text"/></label>
        <label class="checkbox-item"><input name="experience" type="checkbox" value="none"/> 전혀 없음</label>
      </div>
    </div>

    <!-- 3) 면담 의향 -->
    <div style="margin:14px 0">
      <label>연구자의 설문 분석 후 각 코드 유형을 대표하는 선생님들을 대상으로 하는 온라인(줌) 면담이 진행될 수 있습니다. 면담 요청 시 많은 참여 부탁드립니다. 요청 시 면담 참여 가능하십니까? *</label>
      <select id="zoomConsent" required>
        <option value="">선택하세요</option>
        <option value="yes">참여할 의향이 있습니다.</option>
        <option value="no">참여할 의향이 없습니다.</option>
      </select>
    </div>

    <!-- 4) 이메일 & 전화번호 -->
    <div style="margin-top:14px">
      <label for="email">이메일 *</label>
      <input id="email" required type="email"/>
    </div>
    <div>
      <label for="phone">핸드폰 번호 *(설문 참여 감사 기프티콘 발송용)</label>
      <input id="phone"/>
    </div>

    <!-- 5) 연구 동의 -->
    <div class="checkbox-group" style="margin-top:12px">
      <label class="checkbox-item"><input id="consent" type="checkbox"/> 연구 참여에 동의합니다.</label>
    </div>

    <div class="toolbar">
      <button id="nextBtn">다음 (정렬 단계로 이동)</button>
    </div>
  </section>

  <!-- PAGE 2 -->
  <section class="page hidden" id="page2">
    <h2 style="margin:0 0 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">2단계: 선생님께서 Q진술문 카드를 읽어보신 후, 본인의 생각에 따라 ‘매우 비동의’에서부터 ‘매우 동의’ 사이의 위치에 알맞게 배치해 주세요.<button class="help-btn" id="helpBtn">👉 Q진술문 배치 요령을 반드시 읽어주세요</button></h2>

    <div class="modal hidden" id="helpModal">
      <div class="modal__overlay"></div>
      <div class="modal__content">
        <h3 style="margin-top:0">Q진술문 배치 요령</h3>
        <ul style="line-height:1.75">
          <li>각 카드의 진술은 교사의 국가수준 교육과정 해석과 관련한 교사의 인식, 태도들 담고 있습니다. 카드 배치 전 39개의 진술을 먼저 읽어주세요</li>
          <li>카드 진술문에 대한 선생님의 동의, 미동의 정도에 따라 카드를 옮겨주시면 됩니다.</li>
          <li>양 극단에 해당하는 매우 비동의, 매우 동의 하는 진술부터 배치하시고 중립(판단 보류)에 해당하는 진술을 마지막에 배치하시면 응답하기가 편리하실 것입니다.</li>
          <li>카드 배치를 수정하고 싶으실 경우, 옮기실 카드를 카드 풀로 옮기시면 됩니다. 처음부터 다시 진행하시고 싶으실 경우, 분포 초기화 버튼을 누르시면 됩니다.</li>
          <li>각 동의/비동의 단계에 배치할 수 있는 카드의 수는 강제 정규 분포가 이루어지도록 설정되어 있으며, 선생님께서 배치하는 카드의 숫자가 보일 것 입니다.</li>
        </ul>
        <div style="margin:10px 0 14px">
          <div>-4 (매우 비동의) → 2개</div>
          <div>-3 (비동의) → 3개</div>
          <div>-2 (다소 비동의) → 4개</div>
          <div>-1 (약간 비동의) → 6개</div>
          <div>0 (중립/판단 보류) → 9개</div>
          <div>1 (약간 동의) → 6개</div>
          <div>2 (다소 동의) → 4개</div>
          <div>3 (동의) → 3개</div>
          <div>4 (매우 동의) → 2개</div>
        </div>
        <div style="text-align:right"><button id="helpClose">닫기</button></div>
      </div>
    </div>

    <div class="grid">
      <aside>
        <h2 style="margin:8px 0 6px;font-size:16px">카드 풀(미배치)</h2>
        <div class="dropzone" data-score="pool" id="pool">
          <div class="note">여기에 놓으면 카드가 ‘미배치’ 상태가 됩니다.</div>
          <div class="bucket" id="poolList"></div>
        </div>
        <details style="margin-top:10px">
          <summary>현재 배치 요약</summary>
          <div class="small" id="summary" style="margin-top:6px;white-space:pre-wrap"></div>
        </details>
        <div class="toolbar" style="margin-top:16px">
          <button id="resetBtn">분포 초기화</button>
          <button id="backBtn">뒤로 (응답자 정보)</button>
          <button id="submitBtn">제출</button>
        </div>
      </aside>
      <section>
        <h2 style="margin:8px 0 6px;font-size:16px">Q소팅 분포도</h2>
        <div class="board">
          <div class="cols">
            <div class="row" id="row"></div>
          </div>
        </div>
      </section>
    </div>

    <div class="modal hidden" id="thankModal">
      <div class="modal__overlay"></div>
      <div class="modal__content">
        <h3>설문 제출 완료</h3>
        <p>설문에 참여해 주셔서 감사합니다.</p>
        <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
          <button id="thankClose">닫기</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
// === Uniform card height ===
function setUniformCardSize(){
  document.querySelectorAll('.card').forEach(c=>{ c.style.height='auto'; });
  let maxH = 0;
  document.querySelectorAll('.card').forEach(c=>{ maxH = Math.max(maxH, c.offsetHeight); });
  if(maxH < 56) maxH = 56;
  document.documentElement.style.setProperty('--card-h', maxH + 'px');
}
window.addEventListener('resize', ()=> setUniformCardSize());

// ===== 설정: 39문항 / 9점 척도 =====
const PRESET_39 = {
  scores:[-4,-3,-2,-1,0,1,2,3,4],
  caps:[  2,  3,  4,  6, 9, 6, 4, 3, 2],
  labels:[
    "-4 (매우 비동의)","-3 (비동의)","-2 (다소 비동의)","-1 (약간 비동의)",
    "0 (중립/판단 보류)","1 (약간 동의)","2 (다소 동의)","3 (동의)","4 (매우 동의)"
  ]
};
const STATEMENTS = [
  {id:1, text:"지리 수업에서 제시하는 학습 목표는 현실 세계의 복잡성을 드러내기보다 단순화된 틀과 구호로 반복된다고 느낀다."},
  {id:2, text:"교사는 학생의 실제 경험보다 국가 수준 교육과정 문서 속 서술이나 교과서 예시에 맞추어 수업을 꾸릴 수밖에 없다고 생각한다."},
  {id:3, text:"국가 수준 교육과정에 제시된 성취기준은 실제 지리 현상을 탐구하게 하기보다 모범 답안을 찾게 만드는 경향이 강하다."},
  {id:4, text:"학생들의 학습 활동 참여는 자율적인 탐구라기보다 국가 수준 교육과정 문서가 요구하는 형식적 수행으로 흐른다고 본다."},
  {id:5, text:"지리 교육에서 강조하는 학습 목표, 개념들은 현실의 복잡한 문제나 갈등을 담지 못하고, 국가 수준 교육과정 문서, 교과서 속에서 정해진 문구처럼 형식적으로 다뤄진다."},
  {id:6, text:"교사의 교육과정 해석은 학생과 교사가 맞닥뜨리는 구체적이고 복잡한 지리적 삶의 맥락보다는, 국가 수준 교육과정 문서와 평가 관련 지침에 더 충실해질 수밖에 없다고 생각한다."},
  {id:7, text:"지리적 문제 및 쟁점은 복잡한 현실 문제로 다뤄지기보다 단순한 사례와 도식으로만 제시되어 간단하게 다뤄진다고 본다."},
  {id:8, text:"국가 수준의 교육과정의 지시는 교사의 창의적 해석보다는 획일적인 활동으로 귀결되는 경우가 많다."},
  {id:9, text:"학생들은 실제 지역 사회보다 교과서 안에서 정형화된 지리적 개념 및 탐구를 배우는 데 익숙해진다고 느낀다."},
  {id:10, text:"국가수준 교육과정 문서에서 반복적으로 강조되는 용어나 개념은 실제 지리 현상과 연결되기보다, 국가수준 교육과정 문서와 교과서 안에서 정해진 문구와 예시로만 반복된다."},
  {id:11, text:"지리 교육은 종종 학생의 실제 이해보다, 국가수준 교육과정이 정해 놓은 성취기준이나 평가 기준을 충족하는 것에 더 치중하게 된다."},
  {id:12, text:"국가수준 성취기준이 제시하는 목표들은 학생들의 삶과 무관한 채 ‘해야 하는 것’으로만 받아들여질 위험이 크다고 본다."},
  {id:13, text:"학생의 학습 성취 여부가 루브릭(채점 기준표)과 같은 표준화된 평가 지표로 측정될 때, 학생은 학습 보다 평가 지표 맞추기에 집중하게 된다고 본다."},
  {id:14, text:"국가수준 교육과정에 제시된 지리 학습의 목표들은 정해진 답으로만 읽히지 않고, 교사가 처한 지역적 맥락이나 학생들의 삶에 따라 달리 해석될 수 있다고 본다."},
  {id:15, text:"국가수준 교육과정에 제시된 성취기준 달성을 위해 학생에게 제공하는 학습 경험은 교과서에서 제시된 활동 뿐만 아니라, 주변 지역의 지리 현상이나 학생 경험으로 자유롭게 확장할 수 있다고 생각한다."},
  {id:16, text:"국가가 정한 지리 교육의 내용과 방법과 같은 틀은 분명 문서로서 존재하지만, 교사가 현장에서 재구성하면서 새로운 수업 흐름을 만들어낼 수 있는 여지가 충분하다고 본다."},
  {id:17, text:"국가수준 교육과정 문서에서 제시하는 지리 수업의 목표, 내용, 방법들은 교사와 학생이 함께 실험해보고 변형할 수 있는 열린 지점으로 이해된다."},
  {id:18, text:"정형화된 성취기준, 학습 목표조차도 교사의 선택에 따라 다른 모습으로 구현될 수 있다는 점이 중요하다고 본다."},
  {id:19, text:"국가수준 교육과정 문서에 없는 지리적 주제를 다루더라도 학생 삶과 연결된다면 충분히 교육과정의 의미 안에 포함된다고 여긴다."},
  {id:20, text:"국가수준 교육과정의 지침은 지리 교사에게 통제의 장치이면서도 동시에 창의적 해석의 가능성을 남겨둔다고 생각한다."},
  {id:21, text:"교사의 교육과정 해석은 국가수준 교육과정 문서에 적힌 기준을 그대로 따르는 것이 아니라, 이를 학생들의 경험 세계와 연결하는 것이라고 본다."},
  {id:22, text:"국가수준 교육과정 문서에서 제시하는 교수․학습 및 평가 방향을 완전히 따르지 않더라도, 교사가 학생과 지역 상황 맞게 지리 수업을 자율적으로 재구성하여 진행하는 것은 정당하다고 생각한다."},
  {id:23, text:"국가수준 교육과정은 지리 교사에게 단일한 길이 아니라 여러 갈래의 길을 열어주는 출발점으로 읽힌다."},
  {id:24, text:"교사의 교육과정 해석과 실천은 언제나 문서에 적힌 지시보다 더 풍부하고 다양할 수 있다."},
  {id:25, text:"지리 수업에서는 국가수준의 성취기준보다 학생과 지역의 특수성을 먼저 고려해야 한다고 본다."},
  {id:26, text:"지리 수업의 의미는 교사, 학생, 교실 환경, 지역 자료가 어떻게 어울리느냐에 따라 달라지기 때문에 국가수준 교육과정 및 교과에서 제시한 학습 순서도 현장에 맞게 재구성될 수 있다고 본다."},
  {id:27, text:"국가수준 교육과정에서 제시된 지리 교육의 목표들은 단순한 지식 전달을 넘어, 교사 자신이 어떤 존재인지 성찰하게 만드는 계기로 읽힌다."},
  {id:28, text:"학생들이 배우는 지리적 지식, 기능, 가치․태도 등은 결국 자기 삶을 돌아보게 하는 물음이 되어야 한다고 생각한다."},
  {id:29, text:"지리 수업에서 제시되는 학습 목표들은 객관적 지리적 사실의 나열이 아니라, 학생이 어떻게 세계 속에 살아가고 있는지를 묻는 계기라고 본다."},
  {id:30, text:"교사의 교육과정 해석은 학생의 생활세계와 연결될 때 비로소 교육적 의미를 가진다고 느낀다."},
  {id:31, text:"지리 교육은 교사와 학생이 함께 세계와 자기 자신을 성찰하는 장으로 기능해야 한다고 생각한다."},
  {id:32, text:"국가가 제시하는 지리 교육의 목표는 학생이 자기 가능성을 발견하는 기회로 전환될 수 있다고 본다."},
  {id:33, text:"국가수준 교육과정 문서가 말하는 성취기준들은 단순히 외워야 할 지식이 아니라, 삶의 문제와 연결될 때 의미가 있다고 본다."},
  {id:34, text:"학생은 지리를 통해 자기 삶과 세계를 질문하고 대답할 수 있어야 한다고 여긴다."},
  {id:35, text:"지리 교육에서 중요한 것은 사실의 축적보다 자신의 경험 속에서 의미를 발견하는 것이라고 생각한다."},
  {id:36, text:"교사는 학생이 수동적으로 배우는 존재가 아니라, 자기 삶을 주체적으로 살아가는 존재가 되도록 돕는다고 본다."},
  {id:37, text:"국가수준 교육과정 문서를 읽는 일은 교사에게도 자기 존재를 새롭게 이해하는 기회가 된다."},
  {id:38, text:"지리 수업은 교사와 학생이 함께 세계 속에서 살아가고 있다는 사실을 드러내는 장이라고 생각한다."},
  {id:39, text:"국가수준 교육과정 및 교과서 지시대로만 진행하는 수업은 교사와 학생의 발전을 막기 때문에, 큰 흐름만 참고해 교사가 새롭게 수업을 구성할 때 교사와 학생 모두 성장할 수 있다."}
];
let cards = JSON.parse(JSON.stringify(STATEMENTS));
let columns = [];
let selectedCardId = null;
let SUBMITTED = false;
let SUBMITTING = false;

const poolList = null; // will be set in initApp
let rowEl = null;
let summaryEl = null;

function showPage(n){
  document.getElementById('page1').classList.toggle('hidden', n!==1);
  document.getElementById('page2').classList.toggle('hidden', n!==2);
}

function validateRespondent(){
  const career = document.getElementById('career').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const schoolLevel = document.getElementById('schoolLevel').value.trim();
  if(!schoolLevel){ alert('현재 근무하고 계신 학교급을 선택하세요.'); return false; }
  const email = document.getElementById('email').value.trim();
  const zoomConsent = document.getElementById('zoomConsent').value.trim();
  const consent = document.getElementById('consent').checked;
  const checked = [...document.querySelectorAll('#experience-options input[name="experience"]:checked')];
  const otherChecked = checked.some(i=> i.value==='other');
  const otherText = (document.getElementById('otherExp')||{}).value ? document.getElementById('otherExp').value.trim() : '';
  if(!career){ alert('교직 경력을 선택하세요.'); return false; }
  if(checked.length===0){ alert('작업 참여 경험을 최소 1개 선택하세요.'); return false; }
  if(checked.some(i=> i.value==='none') && checked.length>1){ alert('"전혀 없음"을 선택한 경우 다른 항목은 선택할 수 없습니다.'); return false; }
  if(otherChecked && !otherText){ alert('기타를 선택하셨다면 내용을 입력해 주세요.'); return false; }
  if(!zoomConsent){ alert('온라인 면담 참여 의향을 선택하세요.'); return false; }
  if(!email){ alert('이메일을 입력하세요.'); return false; }
  if(!phone){ alert('전화번호를 입력하세요.'); return false; }
  if(!consent){ alert('연구 참여 동의를 체크해 주세요.'); return false; }
  return true;
}

function attachNoneExclusive(){
  const expOptions = document.querySelectorAll('#experience-options input[type="checkbox"]');
  const noneOption = document.querySelector('#experience-options input[value="none"]');
  expOptions.forEach(opt=>{
    opt.addEventListener('change', ()=>{
      if(noneOption.checked){ expOptions.forEach(o=>{ if(o!==noneOption) o.checked=false; }); }
      else { if(opt!==noneOption) noneOption.checked=false; }
    });
  });
}

function makeEl(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function getBucket(colEl){ return colEl.querySelector('.bucket'); }
function capStatus(col){
  const bucket = getBucket(col.el); if(!bucket) return;
  const used = bucket.children.length;
  const usednum = col.el.querySelector('.usednum'); if(!usednum) return;
  usednum.textContent = used;
  const cls = used===col.cap? 'count-ok' : (used<col.cap? 'count-warn':'count-bad');
  usednum.className = 'usednum ' + cls; col.el.classList.toggle('over', used>col.cap);
}
function refreshAll(){ columns.forEach(capStatus); updateSummary(); }

function createCardEl(card){
  const el = makeEl('div','card'); el.draggable=true; el.dataset.id=card.id;
  el.innerHTML = '<div class="small" style="opacity:.7">#'+card.id+'</div>'+card.text;
  el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', String(card.id)); });
  el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
  el.addEventListener('click', ()=>{
    if(selectedCardId===card.id){ selectedCardId=null; el.style.outline=''; return; }
    document.querySelectorAll('.card').forEach(c=> c.style.outline='');
    selectedCardId=card.id; el.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`;
  });
  return el;
}

function ensureCards(){
  const poolListEl = document.getElementById('poolList');
  poolListEl.innerHTML='';
  cards.forEach(c=> poolListEl.appendChild(createCardEl(c)));
  refreshAll();
}

function attachDnD(){
  const zones = document.querySelectorAll('.dropzone');
  zones.forEach(z=>{
    z.addEventListener('dragover', e=>{ e.preventDefault(); z.classList.add('over'); });
    z.addEventListener('dragleave', ()=> z.classList.remove('over'));
    z.addEventListener('drop', e=>{ e.preventDefault(); z.classList.remove('over'); const id=+e.dataTransfer.getData('text/plain'); moveCardTo(id,z); });
    z.addEventListener('click', ()=>{ if(selectedCardId!=null){ moveCardTo(selectedCardId,z); selectedCardId=null; document.querySelectorAll('.card').forEach(c=> c.style.outline=''); }});
  });
}

function moveCardTo(id, zone){
  const cardEl = document.querySelector(`.card[data-id="${id}"]`); if(!cardEl) return;
  const poolListEl = document.getElementById('poolList');
  const targetBucket = zone.id==='pool' ? poolListEl : getBucket(zone);
  if(zone.id!=='pool'){
    const col = columns.find(c=> String(c.score)===zone.dataset.score);
    if(getBucket(zone).children.length>=col.cap){ zone.classList.add('over'); setTimeout(()=> zone.classList.remove('over'), 300); return; }
  }
  targetBucket.appendChild(cardEl); refreshAll(); setUniformCardSize();
}

function updateSummary(){
  const summaryEl = document.getElementById('summary');
  if(!summaryEl) return;
  const lines=[]; columns.forEach(c=>{ const b=getBucket(c.el); const ids=b?[...b.children].map(e=> e.dataset.id):[]; lines.push(`${c.score}: ${ids.join(', ')||'-'}`); });
  const poolIds=[...document.getElementById('poolList').children].map(e=> e.dataset.id); lines.push(`미배치: ${poolIds.join(', ')||'-'}`); summaryEl.textContent=lines.join('\n');
}

function renderColumns(){
  const rowElLocal = document.getElementById('row');
  rowElLocal.innerHTML=''; columns=[];
  const {scores,caps,labels} = PRESET_39;
  scores.forEach((score,i)=>{
    const col = makeEl('div','col dropzone');
    col.dataset.score = score;
    const head = makeEl('div','col-header');
    const tag = makeEl('div','tag'); tag.textContent = labels[i];
    const cap = makeEl('div','cap'); cap.innerHTML = `할당 <span class="capnum">${caps[i]}</span> / <span class="usednum">0</span>`;
    head.append(tag,cap);
    const bucket = makeEl('div','bucket');
    col.append(head,bucket); rowElLocal.append(col);
    columns.push({score, cap:caps[i], el:col});
  });
  attachDnD(); refreshAll();
}

function initPageHandlers(){
  document.getElementById('nextBtn').addEventListener('click', ()=>{ if(validateRespondent()) showPage(2); });
  document.getElementById('backBtn')?.addEventListener('click', ()=> showPage(1));
  document.getElementById('resetBtn')?.addEventListener('click', ()=>{
    document.querySelectorAll('.col .bucket').forEach(b=>{ [...b.children].forEach(card=> document.getElementById('poolList').appendChild(card)); });
    refreshAll();
  });
  // 도움말 팝업
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('helpModal');
  const helpClose = document.getElementById('helpClose');
  if (helpBtn && helpModal && helpClose){
    helpBtn.addEventListener('click', ()=> helpModal.classList.remove('hidden'));
    helpClose.addEventListener('click', ()=> helpModal.classList.add('hidden'));
    helpModal.querySelector('.modal__overlay').addEventListener('click', ()=> helpModal.classList.add('hidden'));
  }
  // Enter 키 방지 (page2)
  document.addEventListener('keydown', (e)=>{
    const onPage2 = !document.getElementById('page2').classList.contains('hidden');
    if (onPage2 && e.key === 'Enter') { e.preventDefault(); }
  });
}

// === Google Sheets Integration ===
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhxw3kVbBBEJhPGAHXBxoL4S7vZKbqwCK5I5PeaeYEDLIO0u1l2VYwTpAMi-ywRem6og/exec";

function collectQsort(){
  const results = [];
  if (Array.isArray(columns)){
    columns.forEach(c => {
      const b = getBucket(c.el);
      const nodes = b ? Array.from(b.children) : [];
      nodes.forEach(node => {
        const id = Number(node.dataset.id);
        if (!Number.isNaN(id)) results.push({ id, score: Number(c.score) });
      });
    });
  }
  return results;
}

async function submitToSheet(){
  const submitBtn = document.getElementById('submitBtn');
  const payload = {
    career: (document.getElementById('career')?.value || "").trim(),
    schoolLevel: (document.getElementById('schoolLevel')?.value || "").trim(),
    experience: Array.from(document.querySelectorAll('input[name="experience"]:checked')).map(el => el.value),
    experienceOther: (document.getElementById('otherExp')?.value || "").trim(),
    zoomConsent: (document.getElementById('zoomConsent')?.value || "").trim(),
    email: (document.getElementById('email')?.value || "").trim(),
    phone: (document.getElementById('phone')?.value || "").trim(),
    qsort: collectQsort(),
    token: CURRENT_TOKEN || ''
  };
  try {
    await fetch(APPS_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
    // 제출 성공으로 간주 → 토큰 사용 처리(JSONP)
    try { await jsonp(APPS_SCRIPT_URL, { action: 'markUsed', token: CURRENT_TOKEN }); } catch(_){}
    const thankModal = document.getElementById('thankModal');
    if (thankModal) thankModal.classList.remove('hidden');
    return true;
  } catch (err) {
    alert('네트워크 오류로 제출에 실패했습니다. 다시 시도해 주세요.');
    if (submitBtn){ submitBtn.removeAttribute('disabled'); submitBtn.textContent = '제출'; }
    if (typeof SUBMITTING !== 'undefined') SUBMITTING = false;
    return false;
  }
};
  try {
    await fetch(APPS_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
    const thankModal = document.getElementById('thankModal');
    if (thankModal) thankModal.classList.remove('hidden');
    return true;
  } catch (err) {
    alert('네트워크 오류로 제출에 실패했습니다. 다시 시도해 주세요.');
    if (submitBtn){ submitBtn.removeAttribute('disabled'); submitBtn.textContent = '제출'; }
    if (typeof SUBMITTING !== 'undefined') SUBMITTING = false;
    return false;
  }
}

function bindSubmit(){
  document.getElementById('submitBtn').addEventListener('click', ()=>{
    if (SUBMITTING) return;
    SUBMITTING = true;
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn){ submitBtn.setAttribute('disabled','true'); submitBtn.textContent = '제출 중...'; }
    const unmet = columns.filter(c=> getBucket(c.el).children.length !== c.cap);
    if(unmet.length>0){
      alert('분포 용량을 정확히 맞춰 주세요.');
      SUBMITTING = false;
      if (submitBtn){ submitBtn.removeAttribute('disabled'); submitBtn.textContent = '제출'; }
      return;
    }
    submitToSheet();
  });
}

(function thankModalToPage3(){
  function bindConfirmToShowPage3(){
    const confirmBtn = document.getElementById('thankClose') || document.querySelector('#thankModal button');
    const thankModal = document.getElementById('thankModal');
    const submitBtn = document.getElementById('submitBtn');
    if (!confirmBtn || !thankModal) return false;
    if (confirmBtn.__boundOK) return true;
    confirmBtn.__boundOK = true;
    confirmBtn.addEventListener('click', function(){
      try {
        thankModal.classList.add('hidden');
        if (submitBtn){ submitBtn.textContent = '제출 완료'; submitBtn.disabled = true; }
        const p1 = document.getElementById('page1');
        const p2 = document.getElementById('page2');
        const p3 = document.getElementById('page3');
        if (p1) p1.classList.add('hidden');
        if (p2) p2.classList.add('hidden');
        if (p3) p3.classList.remove('hidden');
        window.scrollTo(0,0);
      } catch(e) { console.error('bindConfirmToShowPage3 error:', e); }
    });
    return true;
  }
  let cnt = 0;
  const intervalID = setInterval(() => {
    cnt++;
    if (bindConfirmToShowPage3() || cnt > 20) { clearInterval(intervalID); }
  }, 300);
})();
</script>

<section class="page hidden" id="page3">
  <h2>제출 완료</h2>
  <p>설문에 참여해 주셔서 감사합니다. 결과가 성공적으로 제출되었습니다.</p>
</section>

<script>
// === 카드 풀 정렬 유지 ===
(function(){
  function getCardId(el){
    if (!el) return Number.MAX_SAFE_INTEGER;
    if (el.dataset && el.dataset.id !== undefined && el.dataset.id !== "") {
      var n = Number(el.dataset.id);
      if (!Number.isNaN(n)) return n;
    }
    var m = (el.textContent || "").match(/#\s*(\d+)/);
    return m ? Number(m[1]) : Number.MAX_SAFE_INTEGER;
  }
  var sorting = false;
  function sortPoolAscending(){
    if (sorting) return;
    var pool = document.getElementById('poolList');
    if (!pool) return;
    sorting = true;
    var nodes = Array.prototype.slice.call(pool.children);
    nodes.sort(function(a,b){ return getCardId(a) - getCardId(b); });
    nodes.forEach(function(n){ pool.appendChild(n); });
    sorting = false;
  }
  document.addEventListener('DOMContentLoaded', function(){
    var pool = document.getElementById('poolList');
    if (!pool) return;
    sortPoolAscending();
    var timer = null;
    var obs = new MutationObserver(function(){
      if (sorting) return;
      if (timer) clearTimeout(timer);
      timer = setTimeout(sortPoolAscending, 0);
    });
    obs.observe(pool, { childList: true });
  });
})();
</script>

<!-- === Token Validation Gate === -->
<script>
/**
 * 간단한 토큰 게이트(클라이언트 사이드)
 * - 배포 시, 각 응답자에게 ?t=개별토큰 형태의 URL을 발급하세요.
 * - 아래 LOCAL_ALLOWED_TOKENS에 허용 토큰을 넣으면(권장), 해당 토큰만 접근 가능합니다.
 * - 또는 Google Apps Script에서 action=validate를 구현해 서버 검증을 사용할 수도 있습니다.
 *   예: GET `${APPS_SCRIPT_URL}?action=validate&token=...` 가 `{ ok: true }` 반환
 *
 * ⚠️ 주의: HTML 내부에 토큰 목록을 두는 방식은 강한 보안이 아닙니다. 링크 유출 방지용 1차 장치로 사용하세요.
 */
const LOCAL_ALLOWED_TOKENS = [
  // 예시: "TCH-001-9b2e", "TCH-002-17aa"
];

function getTokenFromURL(){
  const href = String(location.href);
  const u = new URL(href);
  // 1) 쿼리에서 우선 추출
  let t = u.searchParams.get('token') || u.searchParams.get('t') || '';
  if (t) return t;
  // 2) 해시(#)에 붙여온 경우도 허용: #token=... 또는 #t=...
  const h = (location.hash || '').replace(/^#/, '');
  if (h) {
    const params = new URLSearchParams(h);
    t = params.get('token') || params.get('t') || '';
    if (t) return t;
    // 단일값 형태(#abcd1234)로 온 경우도 허용(영숫자 6~32)
    if (/^[A-Za-z0-9_-]{6,32}$/.test(h)) return h;
  }
  return '';
}

// JSONP 유틸(Apps Script CORS 회피)
function jsonp(url, params={}){
  return new Promise((resolve)=>{
    const cbName = 'cb_' + Math.random().toString(36).slice(2);
    params.callback = cbName;
    const qs = Object.entries(params).map(([k,v])=> `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
    const script = document.createElement('script');
    window[cbName] = (data)=>{ try{ resolve(data); } finally { delete window[cbName]; script.remove(); } };
    script.src = `${url}?${qs}`;
    document.head.appendChild(script);
  });
}
async function serverValidateToken(token){
  const data = await jsonp(APPS_SCRIPT_URL, { action: 'checkToken', token });
  // 기대 응답: { ok:true, status:"valid"|"used" } 또는 { ok:false, status:"invalid" }
  return data;
}?action=validate&token=${encodeURIComponent(token)}`);
    if (!res.ok) return false;
    const data = await res.json();
    return !!(data && (data.ok === true || data.valid === true));
  } catch(e){ return false; }
}

let CURRENT_TOKEN = '';
async function checkAccess(){
  const gate = document.getElementById('gate');
  const status = document.getElementById('gateStatus'); const debug = (msg)=>{ if(status) status.textContent = msg; };
  const app = document.getElementById('appRoot');
  const token = getTokenFromURL();
  CURRENT_TOKEN = token;
  if (!token){
    status.textContent = '접속 토큰이 포함되지 않았습니다. 담당자에게 문의해 주세요.';
    gate.classList.remove('hidden');
    app.classList.add('hidden');
    return false;
  }
  // 1) 로컬 허용 목록 우선
  if (LOCAL_ALLOWED_TOKENS.length > 0){
    if (LOCAL_ALLOWED_TOKENS.includes(token)){
      gate.classList.add('hidden'); app.classList.remove('hidden'); initApp(); return true;
    } else {
      status.textContent = '유효하지 않은 토큰입니다. 링크를 다시 확인해 주세요.';
      gate.classList.remove('hidden'); app.classList.add('hidden'); return false;
    }
  }
  // 2) 서버 검증(JSONP)
  status.textContent = '토큰을 확인하는 중…';
  const resp = await serverValidateToken(token);
  if (resp && resp.ok && resp.status === 'valid'){
    gate.classList.add('hidden'); app.classList.remove('hidden'); initApp(); return true;
  }
  if (resp && resp.ok && resp.status === 'used'){
    status.textContent = '이미 사용된 토큰입니다. 담당자에게 문의해 주세요.';
  } else {
    status.textContent = '유효하지 않은 토큰입니다. 링크를 다시 확인해 주세요.';
  }
  gate.classList.remove('hidden'); app.classList.add('hidden');
  return false;
}
  // 1) 로컬 허용 목록 우선
  if (LOCAL_ALLOWED_TOKENS.length > 0){
    if (LOCAL_ALLOWED_TOKENS.includes(token)){
      gate.classList.add('hidden');
      app.classList.remove('hidden');
      initApp();
      return true;
    } else {
      status.textContent = '유효하지 않은 토큰입니다. 링크를 다시 확인해 주세요.';
      gate.classList.remove('hidden');
      app.classList.add('hidden');
      return false;
    }
  }
  // 2) 서버 검증 (선택 사항)
  status.textContent = '서버에서 토큰을 확인하는 중…';
  const ok = await serverValidateToken(token);
  if (ok){
    gate.classList.add('hidden');
    app.classList.remove('hidden');
    initApp();
    return true;
  } else {
    status.textContent = '유효하지 않은 토큰입니다. 링크를 다시 확인해 주세요.';
    gate.classList.remove('hidden');
    app.classList.add('hidden');
    return false;
  }
}

function initApp(){
  // 초기 렌더링 및 이벤트 바인딩
  renderColumns();
  ensureCards();
  setUniformCardSize();
  showPage(1);
  initPageHandlers();
  attachNoneExclusive();
  bindSubmit();
}

// 부팅
document.addEventListener('DOMContentLoaded', checkAccess);
</script>
</body>
</html>
