<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Q-method 설문 (토큰 검증 통합)</title>
<style>
:root{ --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#6366f1; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.page{max-width:900px;margin:20px auto;padding:16px;background:var(--panel);border:1px solid #2b3647;border-radius:14px}
button,select,input,textarea{background:var(--card);color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px 12px;font-size:14px}
.checkbox-group{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.checkbox-item{display:flex;align-items:center;gap:8px}
.small{font-size:12px;color:var(--muted)}
.modal.hidden{display:none}
</style>
</head>
<body>
<header class="wrap"><h1>교사의 교육과정 해석을 통한 의미 구성의 코드 유형 탐구(Q방법론)</h1>
<div class="small">초대 링크(토큰)로 접속해 주세요. 발급된 링크가 있어야 응답 가능합니다.</div></header>

<main class="wrap">
<section class="page" id="page1">
<h2>1단계: 응답자 정보</h2>
<div id="tokenStatus" class="small" style="margin-bottom:8px;color:var(--muted)">초대 링크 확인 중입니다…</div>

<label>교직 경력 *</label>
<select id="career"><option value="">선택</option><option value="under5">5년 미만</option><option value="5to10">5~10년</option></select>

<label>학교급 *</label>
<select id="schoolLevel"><option value="">선택</option><option value="middle">중학교</option><option value="high">고등학교</option></select>

<label>참여 경험 *</label>
<div class="checkbox-group" id="experience-options">
  <label class="checkbox-item"><input type="checkbox" name="experience" value="curriculumDev"/> 국가수준 교육과정 개발</label>
  <label class="checkbox-item"><input type="checkbox" name="experience" value="none"/> 전혀 없음</label>
</div>

<label>온라인 면담 참여 의향 *</label>
<select id="zoomConsent"><option value="">선택</option><option value="yes">예</option><option value="no">아니오</option></select>

<label>이메일 *</label><input id="email" type="email"/>

<label>휴대폰</label><input id="phone" type="text"/>

<div style="margin-top:12px"><label class="checkbox-item"><input id="consent" type="checkbox"/> 연구 참여 동의</label></div>

<div style="margin-top:12px"><button id="nextBtn" disabled>초대 링크 확인 필요</button></div>
</section>

<section class="page hidden" id="page2">
<h2>2단계: Q진술문 배치</h2>

<div id="poolList" style="margin-bottom:12px"></div>
<div id="row"></div>

<div style="margin-top:12px"><button id="backBtn">뒤로</button> <button id="submitBtn">제출</button></div>

<div id="thankModal" class="modal hidden"><div class="modal__content">제출 완료<button id="thankClose">닫기</button></div></div>
</section>
</main>

<script>
// === 핵심 설정: 반드시 이 변수명을 찾아서 깃허브에 반영 가능하게 했습니다.
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyaTHEj45zEdYMpwsIpWjl7kIcYx7MQNRhXLmFQV12BcN-B7mF7kxsG8uNMnK79AYYuQ/exec";

// 유틸
function setTokenUI(status, msg){
  const el = document.getElementById('tokenStatus');
  if(!el) return;
  el.textContent = msg || '';
  if(status==='ok') el.style.color = 'var(--ok)';
  else if(status==='warn') el.style.color = 'var(--warn)';
  else if(status==='info') el.style.color = 'var(--muted)';
  else el.style.color = 'var(--bad)';
  const btn = document.getElementById('nextBtn');
  if(btn){
    if(status==='ok'){ btn.disabled = false; btn.textContent = '다음 (정렬 단계로 이동)'; }
    else if(status==='checking'){ btn.disabled=true; btn.textContent='초대 링크 확인 중…'; }
    else { btn.disabled=true; btn.textContent='초대 링크 확인 필요'; }
  }
}

// URL에서 token 읽기
function getTokenFromURL(){
  try{
    const u = new URL(location.href);
    return (u.searchParams.get('token') || u.searchParams.get('t') || '').trim();
  }catch(e){ return ''; }
}

// 서버에 토큰 확인 요청
async function checkTokenWithServer(token){
  if(!token){ setTokenUI('info','초대 링크가 없는 일반 접속입니다. 초대 메일의 개인 전용 링크로 접속해 주세요.'); return false; }
  setTokenUI('checking','초대 링크를 확인합니다…');
  try{
    // action=checkToken 호출 (GET)
    const qp = new URLSearchParams({ action:'checkToken', token: token });
    const url = APPS_SCRIPT_URL + '?' + qp.toString();
    const res = await fetch(url, { method:'GET', mode:'cors' });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const data = await res.json();
    if(data && data.ok && data.status==='valid'){ setTokenUI('ok','초대 링크 확인 완료'); return true; }
    if(data && data.status==='used'){ setTokenUI('warn','이미 사용된 링크입니다.'); return false; }
    setTokenUI('warn', (data && data.message) || '유효하지 않은 링크입니다.'); return false;
  }catch(err){
    // 서버 호출 자체 실패: 권한/배포 문제 가능성
    console.error('checkToken error', err);
    setTokenUI('bad','링크 확인 중 오류가 발생했습니다. (서버 호출 실패)');
    return false;
  }
}

// 초기: 토큰 읽고 검증
(function init(){
  const token = getTokenFromURL();
  window.__QSORT_TOKEN__ = token;
  if(!token){
    setTokenUI('info','초대 링크가 필요한 페이지입니다. 초대 메일의 링크로 접속해 주세요.');
    return;
  }
  // 검증 호출
  checkTokenWithServer(token);
})();

// 페이지 전환 버튼
document.getElementById('nextBtn').addEventListener('click', function(){
  // 간단 검증
  const career = document.getElementById('career').value;
  const school = document.getElementById('schoolLevel').value;
  const email = document.getElementById('email').value.trim();
  if(!career || !school || !email){ alert('응답자 정보를 모두 입력해 주세요.'); return; }
  document.getElementById('page1').classList.add('hidden');
  document.getElementById('page2').classList.remove('hidden');
});

document.getElementById('backBtn').addEventListener('click', function(){
  document.getElementById('page2').classList.add('hidden');
  document.getElementById('page1').classList.remove('hidden');
});

// 제출: 간단 POST로 APPS_SCRIPT_URL로 전송
document.getElementById('submitBtn').addEventListener('click', async function(){
  const token = window.__QSORT_TOKEN__ || '';
  if(!token){ alert('초대 링크가 누락되었습니다.'); return; }
  // 여기에 분포 데이터 수집 로직이 들어가야 함. 예시로 기본 응답만 전송합니다.
  const payload = {
    action: 'submit',
    token: token,
    career: document.getElementById('career').value || '',
    schoolLevel: document.getElementById('schoolLevel').value || '',
    email: document.getElementById('email').value || '',
    phone: document.getElementById('phone').value || ''
  };
  try{
    const res = await fetch(APPS_SCRIPT_URL, { method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(data && data.ok){ document.getElementById('thankModal').classList.remove('hidden'); localStorage.setItem('qsort_token_used_' + token, '1'); }
    else { alert('서버 응답 오류: ' + (data && data.message || '')); }
  }catch(e){
    console.error('submit error', e);
    alert('제출 중 오류가 발생했습니다.');
  }
});

document.getElementById('thankClose').addEventListener('click', function(){ document.getElementById('thankModal').classList.add('hidden'); });

</script>
</body>
</html>
