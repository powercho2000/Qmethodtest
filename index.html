<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Q‑Sort (응답자 정보 → 정렬/제출)</title>
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#6366f1; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.6));backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px}
    .hidden{display:none}
    button,select,input,textarea{background:var(--card);color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px 12px}
    button{font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    button:hover{border-color:var(--accent)}
    input,textarea,select{width:100%}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:12px}
    #pool,.col{background:var(--panel);border:1px solid #2b3647;border-radius:12px}
    #pool{padding:12px;min-height:220px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .note{font-size:13px;color:var(--muted)}
    .cols{display:grid;gap:10px}
    .row{display:grid;gap:10px;grid-template-columns:repeat(9,1fr)}
    .col{min-height:120px;padding:8px;display:flex;flex-direction:column}
    .col-header{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;margin-bottom:6px;border-bottom:1px dashed #334155}
    .tag{font-size:12px;color:var(--muted)}
    .cap{font-size:12px}
    .bucket{display:flex;flex-direction:column;gap:6px}
    .card{background:var(--card);border:1px solid #334155;border-radius:12px;padding:10px;cursor:grab}
    .card.dragging{opacity:.6}
    .col.over{outline:2px dashed var(--accent);outline-offset:-4px}
    .count-ok{color:var(--ok)}
    .count-warn{color:var(--warn)}
    .count-bad{color:var(--bad)}
    .small{font-size:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#0b1222;border:1px solid #2b3647;border-radius:999px;padding:2px 8px;font-size:12px}
    .page{max-width:900px;margin:20px auto;padding:16px;background:var(--panel);border:1px solid #2b3647;border-radius:14px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Q‑Sort — 2단계(응답자 정보 → 정렬/제출)</h1>
      <div class="sub">1단계에서 정보를 입력하고, 2단계에서 카드를 분포에 맞춰 배치한 뒤 제출하세요.</div>
    </div>
  </header>

  <main class="wrap">
    <section id="page1" class="page">
      <h2 style="margin:0 0 12px">① 응답자 정보</h2>
      <div class="row2">
        <div>
          <label for="name">이름 *</label>
          <input id="name" />
        </div>
        <div>
          <label for="career">경력</label>
          <input id="career" />
        </div>
        <div>
          <label for="phone">전화번호 *</label>
          <input id="phone" />
        </div>
        <div>
          <label for="email">이메일</label>
          <input id="email" type="email" />
        </div>
      </div>
      <label for="note" style="margin-top:14px">추가 메모</label>
      <textarea id="note" rows="4"></textarea>

      <div style="margin:10px 0">
        <label class="small"><input type="checkbox" id="consent" /> 연구 참여에 동의합니다.</label>
      </div>

      <div class="toolbar">
        <button id="nextBtn">다음 (정렬 단계로 이동)</button>
      </div>
    </section>

    <section id="page2" class="hidden">
      <div class="grid">
        <aside>
          <h2 style="margin:8px 0 6px;font-size:16px">카드 풀(미배치)</h2>
          <div id="pool" class="dropzone" data-score="pool">
            <div class="note">여기에 놓으면 카드가 ‘미배치’ 상태가 됩니다.</div>
            <div id="poolList" class="bucket"></div>
          </div>

          <div class="toolbar">
            <select id="preset">
              <option value="40-9">분포 프리셋: 40문항 · 9점 (2,3,5,6,8,6,5,3,2)</option>
              <option value="39-9">분포 프리셋: 39문항 · 9점 (2,3,4,6,9,6,4,3,2)</option>
              <option value="36-9">분포 프리셋: 36문항 · 9점 (2,4,6,8,8,8,6,4,2)</option>
            </select>
            <button id="reset">분포 초기화</button>
          </div>

          <details style="margin-top:10px">
            <summary>현재 배치 요약</summary>
            <div id="summary" class="small" style="margin-top:6px"></div>
          </details>

          <div class="toolbar" style="margin-top:16px">
            <button id="backBtn">뒤로 (응답자 정보)</button>
            <button id="submitBtn">제출</button>
          </div>
        </aside>

        <section>
          <div class="cols">
            <div class="row" id="row"></div>
          </div>
          <div class="chips" id="legend"></div>
        </section>
      </div>
    </section>
  </main>

  <script>
    // ====== 설정 ======
    const ENDPOINT = "https://script.google.com/macros/s/AKfycby49WESEW1dMDoADMc9t0-BGWZdpSVYFDRrEe_ofgyUgLZMi-xZirHpOkIN0nU5LaxcKg/exec"; // Apps Script /exec URL

    // 1회 제출 토큰(응답ID) — 페이지 로드 시 생성
    const RESP_ID = `Q-${new Date().toISOString().replace(/[-:T.Z]/g,'').slice(0,14)}-${Math.random().toString(36).slice(2,7)}`;
    let SUBMITTED = false; // 이 탭에서 중복 제출 방지

    const PRESETS = {
      '40-9': { scores:[-4,-3,-2,-1,0,1,2,3,4], caps:[2,3,5,6,8,6,5,3,2] },
      '39-9': { scores:[-4,-3,-2,-1,0,1,2,3,4], caps:[2,3,4,6,9,6,4,3,2] },
      '36-9': { scores:[-4,-3,-2,-1,0,1,2,3,4], caps:[2,4,6,8,8,8,6,4,2] }
    };

    // 데모 카드(필요 시 교체)
    const DEFAULT_STATEMENTS = Array.from({length:40}, (_,i)=>({id:i+1, code:'', text:`진술문 #${i+1}`}));

    let cards = JSON.parse(JSON.stringify(DEFAULT_STATEMENTS));
    let columns = [];
    let currentPreset = '40-9';
    let selectedCardId = null;

    const poolList = document.getElementById('poolList');
    const rowEl = document.getElementById('row');
    const summaryEl = document.getElementById('summary');
    const presetSel = document.getElementById('preset');

    function showPage(n){
      document.getElementById('page1').classList.toggle('hidden', n!==1);
      document.getElementById('page2').classList.toggle('hidden', n!==2);
    }
    function validateRespondent(){
      const name  = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const consent = document.getElementById('consent').checked;
      if(!name){ alert('이름을 입력하세요.'); return false; }
      if(!phone){ alert('전화번호를 입력하세요.'); return false; }
      if(!consent){ alert('연구 참여 동의를 체크해 주세요.'); return false; }
      return true;
    }
    document.getElementById('nextBtn').addEventListener('click', ()=>{ if(validateRespondent()) showPage(2); });
    document.getElementById('backBtn').addEventListener('click', ()=> showPage(1));

    function makeEl(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
    function renderColumns(){
      rowEl.innerHTML=''; columns=[];
      const {scores,caps} = PRESETS[currentPreset];
      scores.forEach((score,i)=>{
        const col = makeEl('div','col dropzone');
        col.dataset.score = score;
        const head = makeEl('div','col-header');
        const tag = makeEl('div','tag'); tag.textContent = `${score>0? '+'+score: score}`;
        const cap = makeEl('div','cap'); cap.innerHTML = `할당 <span class="capnum">${caps[i]}</span> / <span class="usednum">0</span>`;
        head.append(tag,cap);
        const bucket = makeEl('div','bucket');
        col.append(head,bucket); rowEl.append(col);
        columns.push({score, cap:caps[i], el:col});
      });
      attachDnD(); refreshAll();
    }
    function getBucket(colEl){ return colEl.querySelector('.bucket'); }
    function capStatus(col){
      const bucket = getBucket(col.el); if(!bucket) return;
      const used = bucket.children.length;
      const usednum = col.el.querySelector('.usednum'); if(!usednum) return;
      usednum.textContent = used;
      const cls = used===col.cap? 'count-ok' : (used<col.cap? 'count-warn':'count-bad');
      usednum.className = cls; col.el.classList.toggle('over', used>col.cap);
    }
    function refreshAll(){ columns.forEach(capStatus); updateSummary(); }

    function createCardEl(card){
      const el = makeEl('div','card'); el.draggable=true; el.dataset.id=card.id;
      el.innerHTML = `<div class="small" style=\"opacity:.7\">#${card.id}</div>${card.text}`;
      el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', String(card.id)); });
      el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
      el.addEventListener('click', ()=>{
        if(selectedCardId===card.id){ selectedCardId=null; el.style.outline=''; return; }
        document.querySelectorAll('.card').forEach(c=> c.style.outline='');
        selectedCardId=card.id; el.style.outline=`2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`;
      });
      return el;
    }
    function ensureCards(){ poolList.innerHTML=''; cards.forEach(c=> poolList.appendChild(createCardEl(c))); refreshAll(); }

    function attachDnD(){
      const zones = document.querySelectorAll('.dropzone');
      zones.forEach(z=>{
        z.addEventListener('dragover', e=>{ e.preventDefault(); z.classList.add('over'); });
        z.addEventListener('dragleave', ()=> z.classList.remove('over'));
        z.addEventListener('drop', e=>{ e.preventDefault(); z.classList.remove('over'); const id=+e.dataTransfer.getData('text/plain'); moveCardTo(id,z); });
        z.addEventListener('click', ()=>{ if(selectedCardId!=null){ moveCardTo(selectedCardId,z); selectedCardId=null; document.querySelectorAll('.card').forEach(c=> c.style.outline=''); }});
      });
    }
    function moveCardTo(id, zone){
      const cardEl = document.querySelector(`.card[data-id=\"${id}\"]`); if(!cardEl) return;
      const targetBucket = zone.id==='pool' ? poolList : getBucket(zone);
      if(zone.id!=='pool'){
        const col = columns.find(c=> String(c.score)===zone.dataset.score);
        if(getBucket(zone).children.length>=col.cap){ zone.classList.add('over'); setTimeout(()=> zone.classList.remove('over'), 300); return; }
      }
      targetBucket.appendChild(cardEl); refreshAll();
    }

    function updateSummary(){
      if(!summaryEl) return;
      const lines=[]; columns.forEach(c=>{ const b=getBucket(c.el); const ids=b?[...b.children].map(e=> e.dataset.id):[]; lines.push(`${c.score>0? '+'+c.score:c.score}: ${ids.join(', ')||'-'}`); });
      const poolIds=[...poolList.children].map(e=> e.dataset.id); lines.push(`미배치: ${poolIds.join(', ')||'-'}`); summaryEl.textContent=lines.join('\n');
    }

    presetSel.addEventListener('change', e=>{ currentPreset=e.target.value; renderColumns(); ensureCards(); });
    document.getElementById('reset').addEventListener('click', resetAll);
    function resetAll(){ document.querySelectorAll('.bucket').forEach(b=> b.innerHTML=''); ensureCards(); if(columns.length) columns.forEach(capStatus); updateSummary(); }

    // ====== 제출(버튼 잠금 + no-cors 전송 + 응답ID 포함) ======
    document.getElementById('submitBtn').addEventListener('click', async ()=>{
      if(SUBMITTED){ alert('이미 제출되었습니다. 새로고침 후 다시 시작해 주세요.'); return; }
      const unmet = columns.filter(c=> getBucket(c.el).children.length !== c.cap);
      if(unmet.length>0){ alert('분포 용량을 정확히 맞춰 주세요.'); return; }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; const oldText = btn.textContent; btn.textContent = '제출 중…';

      const payload = {
        respondentId: RESP_ID,
        respondent: {
          name:   document.getElementById('name').value.trim(),
          career: document.getElementById('career').value.trim(),
          phone:  document.getElementById('phone').value.trim(),
          email:  document.getElementById('email').value.trim(),
          note:   document.getElementById('note').value.trim()
        },
        results: []
      };
      columns.forEach(c=>{ [...getBucket(c.el).children].forEach(cardEl=>{ const id=+cardEl.dataset.id; const card=cards.find(k=> k.id===id); payload.results.push({ score:c.score, id:card.id, code:card.code, text:card.text }); }); });

      try{
        await fetch(ENDPOINT, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
        SUBMITTED = true; alert('제출되었습니다. 감사합니다!'); showPage(1); resetAll();
      }catch(err){ alert('제출 중 오류: '+err.message); btn.disabled=false; btn.textContent=oldText; }
    });

    renderColumns(); ensureCards(); showPage(1);
  </script>
</body>
</html>
